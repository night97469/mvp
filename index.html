<!DOCTYPE html>
<html>
<head>
  <title>Night974 - On va o√π ?</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #popupModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
      padding: 20px;
    }
    #popupContent {
      position: relative;
      max-width: 600px;
      max-height: 70vh;
      width: 90%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    #eventDescription {
      padding: 30px;
      max-height: 60vh;
      overflow-y: auto;
      line-height: 1.6;
      font-size: 16px;
    }
    #popupHeader {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      margin: 0;
    }
    #popupClose {
      position: absolute;
      top: 15px; right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      z-index: 10001;
      background: rgba(255,255,255,0.2);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    h1 { text-align: center; margin: 10px 0; color: #333; }
    #eventTitle { margin: 0; font-size: 22px; }
  </style>
</head>
<body>
  <h1>üåô On va o√π ce soir? By Night974</h1>
  <div id="map"></div>

  <!-- Popup Description -->
  <div id="popupModal">
    <div id="popupContent">
      <div id="popupClose">√ó</div>
      <div id="popupHeader">
        <h2 id="eventTitle">√âv√©nement</h2>
      </div>
      <div id="eventDescription">Chargement...</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const popupModal = document.getElementById('popupModal');
    const popupClose = document.getElementById('popupClose');
    const eventTitle = document.getElementById('eventTitle');
    const eventDescription = document.getElementById('eventDescription');

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzr8uxhlBcn-vHkNGSmM6CCz3qlMN54YOtTSuitdIwv9K2zIpy9G-JtpAJr3me2qCYjvFYHqX6Q-Jp/pub?gid=0&single=true&output=csv';

    
// Transforme texte brut -> HTML avec liens cliquables + sauts de ligne
function formatDescriptionWithLinks(text) {
  if (!text) return 'Aucune description disponible.';

  // 1) √âchapper le HTML brut
  let safeText = text.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;');

  // 2) G√©rer d'abord les liens Markdown du type [texte](url)
  safeText = safeText.replace(
    /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
    '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
  );

  // 3) Puis transformer les URL "nues" http(s) qui ne sont PAS d√©j√† dans un lien
  safeText = safeText.replace(
    /(^|[\s])(https?:\/\/[^\s<]+)/g,
    '$1<a href="$2" target="_blank" rel="noopener noreferrer">$2</a>'
  );

  // 4) Et les www. nues (hors lien d√©j√† cr√©√©)
  safeText = safeText.replace(
    /(^|[\s])(www\.[^\s<]+)/g,
    '$1<a href="https://$2" target="_blank" rel="noopener noreferrer">$2</a>'
  );

  // 5) Sauts de ligne
  safeText = safeText.replace(/\n/g, '<br>');

  return safeText;
}


    // Affiche titre + description dans la popup
    function showEventDetails(title, description) {
      eventTitle.textContent = title;
      eventDescription.innerHTML = formatDescriptionWithLinks(description);
      popupModal.style.display = 'flex';
    }

    popupClose.onclick = () => popupModal.style.display = 'none';
    popupModal.onclick = (e) => { if (e.target === popupModal) popupModal.style.display = 'none'; };

    const map = L.map('map').setView([-20.88, 55.47], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap contributors | @Night974'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 13 });
    map.on('locationfound', e => {
      L.marker(e.latlng).addTo(map).bindPopup("üü¢ Vous √™tes ici").openPopup();
    });

    fetch(csvUrl)
      .then(r => r.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true });
        parsed.data.forEach(ev => {
          const lat = parseFloat(ev.Latitude);
          const lng = parseFloat(ev.Longitude);
          const title = ev.Titre || '√âv√©nement';
          const description = ev.Description || '';

          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${title}</b><br>Cliquez pour les d√©tails`);

            marker.on('mouseover', function() { this.openPopup(); });
            marker.on('click', function() { showEventDetails(title, description); });
          }
        });
      })
      .catch(err => {
        console.error('Erreur CSV:', err);
        alert('Erreur chargement des √©v√©nements');
      });
  </script>
</body>
</html>



