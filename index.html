<!DOCTYPE html>
<html>
<head>
  <title>Night974 Mini MVP avec CSV, survol et popup URL</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    /* Styles de la popup */
    #popupModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    #popupContent {
      position: relative;
      width: 90%;
      height: 90%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    #popupContent iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }
    #popupClose {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      z-index: 10001;
    }
  </style>
</head>
<body>
  <h1>On va où ce soir?</h1>
  <div id="map"></div>

  <!-- Popup Modal -->
  <div id="popupModal">
    <div id="popupContent">
      <div id="popupClose">&times;</div>
      <iframe id="popupIframe" src=""></iframe>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ✅ CONSTANTE URL DÉCLARÉE EN PREMIER
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzr8uxhlBcn-vHkNGSmM6CCz3qlMN54YOtTSuitdIwv9K2zIpy9G-JtpAJr3me2qCYjvFYHqX6Q-Jp/pub?gid=0&single=true&output=csv';

    const map = L.map('map').fitWorld();
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 13 });

    function onLocationFound(e) {
      L.marker(e.latlng).addTo(map).bindPopup("Vous êtes ici").openPopup();
    }

    function onLocationError(e) {
      alert("Impossible de récupérer votre localisation.");
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    // Gestion popup iframe
    const popupModal = document.getElementById('popupModal');
    const popupClose = document.getElementById('popupClose');
    const popupIframe = document.getElementById('popupIframe');

    popupClose.onclick = () => {
      popupIframe.src = '';
      popupModal.style.display = 'none';
    };

    function openPopup(url) {
      popupIframe.src = url;
      popupModal.style.display = 'flex';
    }

    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true });
        data.data.forEach(event => {
          const lat = parseFloat(event.Latitude);
          const lng = parseFloat(event.Longitude);
          const title = event.Titre || 'Événement';
          const url = event.lien || '#';

          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map);

            marker.bindPopup(`<b>${title}</b><br>Survolez pour détails`);

            // Survol : ouvre popup info (sans fermer au mouseout)
            marker.on('mouseover', function () {
              this.openPopup();
            });

            marker.on('click', function () {
              openPopup(url);
            });
          }
        });
      })
      .catch(err => {
        console.error('Erreur chargement CSV:', err);
        alert('Erreur chargement des événements. Vérifiez la console.');
      });

    // Fermer popup au clic hors iframe
    popupModal.onclick = (e) => {
      if (e.target === popupModal) {
        popupClose.onclick();
      }
    };
  </script>
</body>
</html>
