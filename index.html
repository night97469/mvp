<!DOCTYPE html>
<html>
<head>
  <title>Night974 Mini MVP - Fonctionnel</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #popupModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    #popupContent {
      position: relative;
      width: 90%;
      height: 90%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    #popupContent iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }
    #popupClose {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      z-index: 10001;
      background: rgba(0,0,0,0.5);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    h1 { text-align: center; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ On va oÃ¹ ce soir? Night974</h1>
  <div id="map"></div>

  <!-- Popup Modal -->
  <div id="popupModal">
    <div id="popupContent">
      <div id="popupClose">Ã—</div>
      <iframe id="popupIframe" src=""></iframe>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Ã‰lÃ©ments DOM (dÃ©clarÃ©s AVANT utilisation)
    const popupModal = document.getElementById('popupModal');
    const popupClose = document.getElementById('popupClose');
    const popupIframe = document.getElementById('popupIframe');
    
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzr8uxhlBcn-vHkNGSmM6CCz3qlMN54YOtTSuitdIwv9K2zIpy9G-JtpAJr3me2qCYjvFYHqX6Q-Jp/pub?gid=0&single=true&output=csv';

    // Fonction globale pour ouvrir popup (accessible partout)
    window.openPopup = function(url) {
      console.log('Ouverture popup:', url); // Debug
      popupIframe.src = url;
      popupModal.style.display = 'flex';
    };

    // Fermeture popup
    popupClose.onclick = () => {
      popupIframe.src = '';
      popupModal.style.display = 'none';
    };

    popupModal.onclick = (e) => {
      if (e.target === popupModal) {
        popupClose.onclick();
      }
    };

    // Initialisation carte
    const map = L.map('map').setView([-20.88, 55.47], 10); // CentrÃ© RÃ©union
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors | Night974'
    }).addTo(map);

    // GÃ©olocalisation
    map.locate({ setView: true, maxZoom: 13 });
    map.on('locationfound', function(e) {
      L.marker(e.latlng).addTo(map)
        .bindPopup("ðŸŸ¢ Vous Ãªtes ici")
        .openPopup();
    });
    map.on('locationerror', function() {
      console.log('GÃ©olocalisation Ã©chouÃ©e');
    });

    // Chargement CSV
    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true });
        console.log('DonnÃ©es CSV:', data.data.length, 'Ã©vÃ©nements'); // Debug
        
        let markerCount = 0;
        data.data.forEach(event => {
          const lat = parseFloat(event.Latitude);
          const lng = parseFloat(event.Longitude);
          const title = event.Titre || 'Ã‰vÃ©nement';
          const url = event.lien || '#';

          if (!isNaN(lat) && !isNaN(lng) && url !== '#') {
            const marker = L.marker([lat, lng]).addTo(map);
            
            marker.bindPopup(`<b>${title}</b><br>Cliquez pour ouvrir`);
            
            // SURVOL
            marker.on('mouseover', function() {
              this.openPopup();
            });
            
            // CLIC - FONCTIONNE MAINTENANT !
            marker.on('click', function() {
              console.log('Clic marker:', title, url); // Debug
              window.openPopup(url);
            });
            
            markerCount++;
          }
        });
        console.log('Markers ajoutÃ©s:', markerCount); // Debug
      })
      .catch(err => {
        console.error('Erreur CSV:', err);
        alert('Erreur chargement Ã©vÃ©nements');
      });
  </script>
</body>
</html>
