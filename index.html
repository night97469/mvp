<!DOCTYPE html>
<html>
<head>
  <title>Night974 - On va o√π ?</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 80vh; width: 100%; }
    #popupModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
      padding: 20px;
    }
    #popupContent {
      position: relative;
      max-width: 600px;
      max-height: 70vh;
      width: 90%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    #eventDescription {
      padding: 30px;
      max-height: 60vh;
      overflow-y: auto;
      line-height: 1.6;
      font-size: 16px;
    }
    #popupHeader {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      margin: 0;
    }
    #popupClose {
      position: absolute;
      top: 15px; right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      z-index: 10001;
      background: rgba(255,255,255,0.2);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    h1 { text-align: center; margin: 10px 0; color: #333; }
    #eventTitle { margin: 0; font-size: 22px; }
    #filters { text-align:center; margin-bottom:10px; }
    #filters button {
      margin: 0 5px;
      padding: 6px 10px;
      border-radius: 16px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #fff;
    }
    #filters button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
  </style>
</head>
<body>
  <h1>üåô On va o√π ce soir? By Night974</h1>

  <div id="filters">
    <button id="btn-today" onclick="setFilter('today')">Aujourd'hui</button>
    <button id="btn-weekend" onclick="setFilter('weekend')">Ce week-end</button>
    <button id="btn-immanquable" onclick="setFilter('immanquable')">Immanquable</button>
  </div>

  <div id="map"></div>

  <!-- Popup Description -->
  <div id="popupModal">
    <div id="popupContent">
      <div id="popupClose">√ó</div>
      <div id="popupHeader">
        <h2 id="eventTitle">√âv√©nement</h2>
      </div>
      <div id="eventDescription">Chargement...</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const popupModal = document.getElementById('popupModal');
    const popupClose = document.getElementById('popupClose');
    const eventTitle = document.getElementById('eventTitle');
    const eventDescription = document.getElementById('eventDescription');

    const btnToday = document.getElementById('btn-today');
    const btnWeekend = document.getElementById('btn-weekend');
    const btnImmanquable = document.getElementById('btn-immanquable');

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzr8uxhlBcn-vHkNGSmM6CCz3qlMN54YOtTSuitdIwv9K2zIpy9G-JtpAJr3me2qCYjvFYHqX6Q-Jp/pub?gid=0&single=true&output=csv';

    let allEvents = [];
    let currentFilter = 'today';

    // Texte -> HTML avec liens cliquables + sauts de ligne
    function formatDescriptionWithLinks(text) {
      if (!text) return 'Aucune description disponible.';

      let safeText = text.replace(/&/g, '&amp;')
                         .replace(/</g, '&lt;')
                         .replace(/>/g, '&gt;');

      safeText = safeText.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'
      );

      safeText = safeText.replace(
        /(^|[\s])(https?:\/\/[^\s<]+)/g,
        '$1<a href="$2" target="_blank" rel="noopener noreferrer">$2</a>'
      );

      safeText = safeText.replace(
        /(^|[\s])(www\.[^\s<]+)/g,
        '$1<a href="https://$2" target="_blank" rel="noopener noreferrer">$2</a>'
      );

      safeText = safeText.replace(/\n/g, '<br>');
      return safeText;
    }

    function showEventDetails(title, description) {
      eventTitle.textContent = title;
      eventDescription.innerHTML = formatDescriptionWithLinks(description);
      popupModal.style.display = 'flex';
    }

    popupClose.onclick = () => popupModal.style.display = 'none';
    popupModal.onclick = (e) => { if (e.target === popupModal) popupModal.style.display = 'none'; };

    const map = L.map('map').setView([-20.88, 55.47], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '¬© OpenStreetMap contributors | @Night974'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 13 });
    map.on('locationfound', e => {
      L.marker(e.latlng).addTo(map).bindPopup("üü¢ Vous √™tes ici").openPopup();
    });

    let markersLayer = L.layerGroup().addTo(map);

    function parseCsvDate(d) {
  if (!d) return null;

  // Cas 1 : format JJMMAAAA HHMMSS (ex: 27112025 220000)
  const match = d.match(/^(\d{2})(\d{2})(\d{4})\s*(\d{0,6})?$/);
  if (match) {
    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10) - 1;
    const year = parseInt(match[3], 10);
    const time = match[4] || '000000';
    const hour = parseInt(time.slice(0, 2), 10) || 0;
    const min = parseInt(time.slice(2, 4), 10) || 0;
    return new Date(year, month, day, hour, min, 0);
  }

  // Cas 2 : formats avec s√©parateurs (12/09/2025, 12-09-2025, 2025-09-12, etc.)
  const parsed = new Date(d);
  if (isNaN(parsed.getTime())) return null;

  return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
}


    function setFilter(filter) {
      currentFilter = filter;
      btnToday.classList.remove('active');
      btnWeekend.classList.remove('active');
      btnImmanquable.classList.remove('active');
      if (filter === 'today') btnToday.classList.add('active');
      if (filter === 'weekend') btnWeekend.classList.add('active');
      if (filter === 'immanquable') btnImmanquable.classList.add('active');
      refreshMarkers();
    }

    function refreshMarkers() {
      markersLayer.clearLayers();
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      const day = today.getDay();
      const saturdayOffset = (6 - day + 7) % 7;
      const sundayOffset = (7 - day) % 7;
      const saturday = new Date(today); saturday.setDate(today.getDate() + saturdayOffset);
      const sunday = new Date(today);   sunday.setDate(today.getDate() + sundayOffset);

      allEvents.forEach(ev => {
        const start = ev.startDate;
        const end = ev.endDate || ev.startDate;
        if (!start) return;

        let keep = false;
        if (currentFilter === 'today') {
          keep = (start <= today && end >= today);
        } else if (currentFilter === 'weekend') {
          keep = (end >= saturday && start <= sunday);
        } else if (currentFilter === 'immanquable') {
          keep = ev.highlight && ev.highlight.trim() !== '';
        }

        if (!keep) return;

        const marker = L.marker([ev.lat, ev.lng]).addTo(markersLayer);
        marker.bindPopup(`<b>${ev.title}</b><br>Cliquez pour les d√©tails`);
        marker.on('mouseover', function(){ this.openPopup(); });
        marker.on('click', function(){ showEventDetails(ev.title, ev.description); });
      });
    }

    fetch(csvUrl)
      .then(r => r.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true });
        allEvents = parsed.data.map(row => {
          const lat = parseFloat(row.Latitude);
          const lng = parseFloat(row.Longitude);
          return {
            lat,
            lng,
            title: row.Titre || '√âv√©nement',
            description: row.Description || '',
            startDate: parseCsvDate(row['Date de d√©but']),
            endDate: parseCsvDate(row['Date de fin']),
            rawStartDate: row['Date de d√©but'],
            rawEndDate: row['Date de fin'],
            highlight: row.Highlight || ''
          };
        }).filter(ev => !isNaN(ev.lat) && !isNaN(ev.lng));
        setFilter('today');
      })
      .catch(err => {
        console.error('Erreur CSV:', err);
        alert('Erreur chargement des √©v√©nements');
      });
  </script>
</body>
</html>



