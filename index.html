<!DOCTYPE html>
<html>
<head>
  <title>Night974 Mini MVP avec CSV</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>#map { height: 90vh; width: 100%; }</style>
</head>
<body>
  <h1>On va où ce soir?</h1>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQzr8uxhlBcn-vHkNGSmM6CCz3qlMN54YOtTSuitdIwv9K2zIpy9G-JtpAJr3me2qCYjvFYHqX6Q-Jp/pub?gid=0&single=true&output=csv';

    const map = L.map('map').fitWorld();
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    map.locate({setView: true, maxZoom: 13});

    function onLocationFound(e) {
      L.marker(e.latlng).addTo(map).bindPopup("Vous êtes ici").openPopup();
    }
    function onLocationError(e) {
      alert("Impossible de récupérer votre localisation.");
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const data = Papa.parse(csvText, {header: true});
        data.data.forEach(event => {
          const lat = parseFloat(event.Latitude);
          const lng = parseFloat(event.Longitude);
          const title = event.Titre || 'Événement';
          const url = event.lien || '#';

          if (!isNaN(lat) && !isNaN(lng)) {
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>${title}</b><br><a href="${url}" target="_blank" rel="noopener">Voir l'événement</a>`);
            marker.on('click', function() {
              window.open(url, '_blank', 'noopener');
            });
          }
        });
      })
      .catch(err => console.error('Erreur chargement CSV:', err));
  </script>
</body>
</html>
